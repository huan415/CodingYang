# 方法区、永久代、元空间

## 方法区（逻辑上）

1. 逻辑上的概念，它是一种 JVM 规范，虚拟机必须遵守的规范
2. 永久代 + 元空间 是方法区的两种实现方式
3. 类信息、常量池、
4. 所有线程共享

## 永久代 PermGen space（JDK7 以前）

## 元空间 Metaspace（JDK8 及以后）

## 永久代和元空间 PK

1. 永久代在 JVM 中，元空间剥离出 JVM 中，直接使用本地内存
2. 为什么要移除永久代
   a. 

## 发展历程

### JDK7 移到常量池

1. JDK6及之前，运行时常量池、字符串常量池在方法区中，方法区--永久代在堆中
2. JDK7，**将字符串常量、静态变量(static) 移到堆中**，即运行时常量池在方法区中，方法区--永久代在堆中
3. JDK8及之后，字符串常量池还在堆，运行时常量池还在方法区，（此时方法区--元空间不在堆中）

### JDK8 为什么使用元空间替换永久代

1. 由于永久代内存经常不够用或者发生内存泄露，爆出异常 java.lang.OutOfMemoryError: PermGen 。
2. 字符串存在永久代中，容易出现性能问题和内存溢出。
3. 类及方法的信息等比较难确定其大小，因此对于永久代的大小指定比较困难，太小容易出现永久代溢出，太大则容易导致老年代溢出。
4. 永久代会位GC带来不必要的复杂度，而且回收效率偏低。
5. Oracle可能会将HotSpot和JRockit合二为一。
   

### **类常量池、运行时常量池、字符串常量池有什么关系？有什么区别？**

类常量池与运行时常量池都存储在方法区，而字符串常量池在jdk7时就已经从方法区迁移到了java堆中。

在类编译过程中，会把类元信息放到方法区，类元信息的其中一部分便是类常量池，主要存放字面量和符号引用，而字面量的一部分便是文本字符，在类加载时将字面量和符号引用解析为直接引用存储在运行时常量池；

对于文本字符来说，它们会在解析时查找字符串常量池，查出这个文本字符对应的字符串对象的直接引用，将直接引用存储在运行时常量池；字符串常量池存储的是字符串对象的引用，而不是字符串本身。



## 参考

1. [方法区、永久代、元空间的区别](https://blog.csdn.net/qq_38262266/article/details/107208357?ivk_sa=1025922q)
2. [java8运行时常量池到底在哪？](https://www.zhihu.com/question/377418017/answer/1062033254?utm_source=wechat_session&utm_medium=social&utm_oi=906889565585944576&utm_content=group3_Answer&utm_campaign=shareopn)
3. [终于搞懂了Java 8 的内存结构，再也不纠结方法区和常量池了](https://zhuanlan.zhihu.com/p/428694393?utm_source=wechat_session&utm_medium=social&utm_oi=906889565585944576&utm_campaign=shareopn)